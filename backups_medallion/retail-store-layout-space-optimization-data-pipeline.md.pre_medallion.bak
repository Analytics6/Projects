# Retail Store Layout & Space Optimization Data Pipeline

Brief: Pipeline to analyze store layout effectiveness and space allocation.

- Objectives:
  - Improve sales per square meter and planogram efficiency.
- Scope:
  - Heatmaps, dwell analytics, planogram experiments.
- Key Components:
  - Customer flow datasets, POS linkages, optimization models.
- Technologies:
  - IoT/footfall data, spatial analytics, optimization solvers.
- Deliverables:
  - Layout recommendations, impact estimates, experiment logs.

## Expanded Source Schemas, ER Diagrams, Facts & Dimensions

Adds five logical sources for layout & space analytics, each with 20 tables, ER diagrams, fact/dimension details, reconciliation guidance, and a rights statement.

Project prefix: `rlso_` (Retail Layout & Space Optimization)

### Source A: Footfall & Sensors (rlso_footfall)

Tables (20):
1. rlso_stg_sensor_events
2. rlso_raw_sensor_events
3. rlso_dim_device
4. rlso_dim_location
5. rlso_dim_floor
6. rlso_ref_device_types
7. rlso_fact_sensor_counts
8. rlso_stage_heatmaps
9. rlso_dim_time
10. rlso_dim_store
11. rlso_audit_ingest
12. rlso_ref_calibration
13. rlso_stage_agg
14. rlso_dim_zone
15. rlso_ref_thresholds
16. rlso_fact_dwell_times
17. rlso_audit_quality
18. rlso_stage_cleaned
19. rlso_ref_epoch
20. rlso_dim_status

ER Diagram (ASCII):

rlso_fact_sensor_counts (count_id, device_id, zone_id, count, measure_ts)
  |-- device_id --> rlso_dim_device(device_id)
  |-- zone_id --> rlso_dim_zone(zone_id)

### Source B: POS & Sales (rlso_sales)

Tables (20):
1. rlso_stg_pos
2. rlso_raw_pos
3. rlso_dim_terminal
4. rlso_dim_product
5. rlso_dim_store
6. rlso_ref_txn_type
7. rlso_fact_sales
8. rlso_stage_promotions
9. rlso_dim_cashier
10. rlso_dim_time
11. rlso_audit_pos_ingest
12. rlso_ref_tax_codes
13. rlso_stage_returns
14. rlso_fact_baskets
15. rlso_dim_channel
16. rlso_ref_price_lists
17. rlso_audit_recon
18. rlso_stage_settlements
19. rlso_ref_discounts
20. rlso_dim_status

### Source C: Experiments & Planograms (rlso_experiments)

Tables (20):
1. rlso_stg_experiments
2. rlso_raw_experiments
3. rlso_dim_experiment
4. rlso_dim_planogram
5. rlso_dim_store
6. rlso_ref_kpis
7. rlso_fact_experiment_results
8. rlso_stage_variations
9. rlso_dim_time
10. rlso_dim_category
11. rlso_audit_experiment_ingest
12. rlso_ref_winner_criteria
13. rlso_stage_segmentations
14. rlso_fact_lift_metrics
15. rlso_dim_team
16. rlso_ref_stat_tests
17. rlso_audit_repro
18. rlso_stage_cleaned
19. rlso_ref_sampling
20. rlso_dim_status

### Source D: Inventory & SKU Flow (rlso_inventory)

Tables (20):
1. rlso_stg_inventory
2. rlso_raw_inventory
3. rlso_dim_sku
4. rlso_dim_location
5. rlso_dim_supplier
6. rlso_ref_lead_times
7. rlso_fact_stock_levels
8. rlso_stage_replenishments
9. rlso_dim_time
10. rlso_dim_store
11. rlso_audit_inventory_ingest
12. rlso_ref_reorder_rules
13. rlso_stage_movements
14. rlso_fact_turnover
15. rlso_dim_category
16. rlso_ref_packaging
17. rlso_audit_recon
18. rlso_stage_adjustments
19. rlso_ref_units
20. rlso_dim_status

### Source E: External Benchmarks & Weather (rlso_external)

Tables (20):
1. rlso_stg_external_feeds
2. rlso_raw_external
3. rlso_dim_source
4. rlso_dim_metric
5. rlso_dim_region
6. rlso_ref_mapping
7. rlso_fact_external_metrics
8. rlso_stage_merged
9. rlso_dim_time
10. rlso_dim_store
11. rlso_audit_external_ingest
12. rlso_ref_units
13. rlso_stage_alignments
14. rlso_fact_correlation
15. rlso_dim_weather_event
16. rlso_ref_thresholds
17. rlso_audit_recon
18. rlso_stage_transforms
19. rlso_ref_codes
20. rlso_dim_status

## Common Guidance
- Use heatmap generation tables and link POS sales to sensor zones to compute sales-per-square-meter.
- Maintain `audit_*` tables for reconciliation and dashboards.

## Detailed ER Diagram

# Detailed ER Diagram: Entities, Attributes, Relationships, Cardinalities

This detailed ER diagram template expands the ASCII ER stub into full entity descriptions, attribute lists, primary/foreign key definitions, and explicit relationships with cardinalities for the project prefix `retail_store_layout_space_optimization_data_pipeline` (source file `retail-store-layout-space-optimization-data-pipeline.md`).

The template covers a canonical canonical set of logical entities used across projects: Source/Stage/Raw, Dimension entities, Fact entities, Reference / Lookup tables, and Audit & Reconciliation tables.

---

**Entity: `retail_store_layout_space_optimization_data_pipeline_raw_records`**
- Purpose: Immutable raw ingest payload store (one row per source record).
- PK: `record_key`
- Key attributes: `record_key (PK)`, `source_system`, `raw_payload` (JSON), `ingest_ts`, `ingest_batch_id`, `payload_hash`.

**Entity: `retail_store_layout_space_optimization_data_pipeline_stg_<topic>`** (generic staging)
- Purpose: Parsed staging of a raw record specific to a topic (e.g. transactions, events).
- PK: `stg_id`
- Key attributes: `stg_id (PK)`, `record_key (FK -> retail_store_layout_space_optimization_data_pipeline_raw_records.record_key)`, `parsed_fields...`, `ingest_ts`, `batch_id`, `load_status`.

**Entity: `retail_store_layout_space_optimization_data_pipeline_dim_account`**
- Purpose: Account dimension used by transaction facts.
- PK: `account_id`
- Attributes: `account_id (PK)`, `customer_id`, `account_type`, `currency_code`, `open_date`, `close_date`, `status`, `valid_from`, `valid_to`.

**Entity: `retail_store_layout_space_optimization_data_pipeline_dim_customer`**
- Purpose: Customer master attributes and identity.
- PK: `customer_id`
- Attributes: `customer_id (PK)`, `first_name`, `last_name`, `email_hash`, `birth_date`, `kyc_level`, `country`, `risk_score`, `valid_from`, `valid_to`.

**Entity: `retail_store_layout_space_optimization_data_pipeline_dim_time`**
- Purpose: Standard time dimension for reporting.
- PK: `date_key`
- Attributes: `date_key (PK)`, `date`, `year`, `quarter`, `month`, `day`, `weekday`, `is_business_day`.

**Entity: `retail_store_layout_space_optimization_data_pipeline_dim_product`**
- Purpose: Product/SKU master for retail-like facts.
- PK: `product_id`
- Attributes: `product_id (PK)`, `sku`, `name`, `category`, `brand`, `size`, `color`, `status`, `valid_from`, `valid_to`.

**Entity: `retail_store_layout_space_optimization_data_pipeline_fact_transactions`**
- Purpose: Canonical transaction-level fact (grain: one event/transaction).
- PK: `transaction_id`
- Attributes: `transaction_id (PK)`, `source_event_id`, `account_id (FK)`, `customer_id (FK)`, `product_id (FK)`, `amount`, `currency_code`, `amount_usd`, `txn_type`, `channel_code`, `merchant_id`, `status`, `posted_ts`, `processed_ts`, `ingest_batch_id`, `checksum`.

---

Relationships and cardinalities (explicit):
- `retail_store_layout_space_optimization_data_pipeline_fact_transactions.account_id` (M:1) -> `retail_store_layout_space_optimization_data_pipeline_dim_account.account_id`
  - Cardinality: Many transactions map to one account.
- `retail_store_layout_space_optimization_data_pipeline_fact_transactions.customer_id` (M:1) -> `retail_store_layout_space_optimization_data_pipeline_dim_customer.customer_id`
  - Many transactions per customer; some transactions inferred to customer through account linkage.
- `retail_store_layout_space_optimization_data_pipeline_fact_transactions.product_id` (M:1) -> `retail_store_layout_space_optimization_data_pipeline_dim_product.product_id`
  - Many fact rows reference a single product row.
- `retail_store_layout_space_optimization_data_pipeline_fact_transactions.posted_ts` (M:1) -> `retail_store_layout_space_optimization_data_pipeline_dim_time.date_key` (via date_key derived from posted_ts)
  - Many transactions map to one date in the time dimension.
- `retail_store_layout_space_optimization_data_pipeline_stg_<topic>.record_key` (M:1) -> `retail_store_layout_space_optimization_data_pipeline_raw_records.record_key`
  - One staging row per raw record, after parsing.

Association tables / many-to-many patterns:
- If customers belong to segments or tags, model as `retail_store_layout_space_optimization_data_pipeline_rel_customer_segment(customer_id FK, segment_id FK, assigned_ts)` with PK composite (`customer_id`, `segment_id`).

Detailed ER rules & integrity constraints:
- Use FK constraints where possible in the curated warehouse (e.g., `FOREIGN KEY (account_id) REFERENCES retail_store_layout_space_optimization_data_pipeline_dim_account(account_id)`).
- Enforce uniqueness on natural keys (e.g., `transaction_id`, `account_id + source_event_id` as alternate key) and use checksums for content verification.
- Implement SCD2 pattern for dimensions needing history using `valid_from` and `valid_to` and a surrogate `dim_pk`.

Sample SQL DDL snippets (representative):

CREATE TABLE retail_store_layout_space_optimization_data_pipeline_dim_customer (
  customer_id STRING PRIMARY KEY,
  first_name STRING,
  last_name STRING,
  email_hash STRING,
  kyc_level STRING,
  risk_score DOUBLE,
  valid_from DATE,
  valid_to DATE
);

CREATE TABLE retail_store_layout_space_optimization_data_pipeline_fact_transactions (
  transaction_id STRING PRIMARY KEY,
  source_event_id STRING,
  account_id STRING,
  customer_id STRING,
  product_id STRING,
  amount DECIMAL(18,2),
  currency_code STRING,
  posted_ts TIMESTAMP,
  ingest_batch_id STRING,
  checksum STRING,
  FOREIGN KEY (account_id) REFERENCES retail_store_layout_space_optimization_data_pipeline_dim_account(account_id),
  FOREIGN KEY (customer_id) REFERENCES retail_store_layout_space_optimization_data_pipeline_dim_customer(customer_id)
);

ER Diagram (visual guidance):
- Center the `retail_store_layout_space_optimization_data_pipeline_fact_transactions` as the hub with outward links to `dim_account`, `dim_customer`, `dim_product`, and `dim_time`.
- Secondary facts (e.g., `retail_store_layout_space_optimization_data_pipeline_fact_settlements`) link back to `fact_transactions` via `transaction_id` where the settlement is child of a transaction (1:M relationship).

---

Per-project extension guidance:
- For banking projects, expand `dim_account` and `dim_customer` with regulatory attributes (aml_flags, kyc_date, tax_id_hash).
- For retail projects, extend `dim_product` with merchandising attributes and `dim_store` to represent brick-and-mortar locations.
- For IoT/telemetry projects, add time-series entity `retail_store_layout_space_optimization_data_pipeline_ts_measurements(device_id, measure_ts, metric, value)` with retention and rollup rules described.

This template is intended to be expanded with project-specific entities. The automation script will replace `retail_store_layout_space_optimization_data_pipeline` and `retail-store-layout-space-optimization-data-pipeline.md` and append the section to each markdown file that does not already contain a `## Detailed ER Diagram` marker.

